#!/usr/bin/env ruby
require_relative '../lib/rmk.rb'

controller = Rmk::Controller.new()

OptionParser.new do |opts|
  opts.banner = "Usage: rmk.rb [options] [target]"

  opts.on("-C", "--directory [directory]", "Change to directory ") do |v|
    controller.dir = v
  end
  opts.on("-r", "--readonly", "Raise exception when files are rebuild") do |v|
    controller.policy = Rmk::ModificationTimeBuildPolicy.new(true)
  end
  opts.on("-a", "--always", "build files unconditionally") do |v|
    controller.policy = Rmk::AlwaysBuildPolicy.new()
  end
  opts.on("-c", "--cache [url]", "use build cache ") do |v|
    controller.policy = Rmk::CacheBuildPolicy.new(v)
  end
  opts.on("-v", "--verbose", "verbose mode ") do |v|
    Rmk.verbose += 1
  end
  opts.on("-j", "--jobs [N]", "allow N jobs at parallel") do |v|
    Rmk::WorkItem.jobs = v.to_i
  end
end.parse!

controller.task = ARGV[0] || controller.task
result = 0
EventMachine.run do
  result = controller.run()
end
exit(result)
